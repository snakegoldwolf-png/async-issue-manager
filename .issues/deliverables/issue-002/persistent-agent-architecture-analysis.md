# 永续 Agent 系统架构 - 学习与对比分析

**Issue #002 [P1]** - Hunter 学习笔记  
**日期**: 2026-02-25  
**来源**: @xxx111god 推文分享

---

## 📚 学习内容总结

### 核心问题：普通 AI Agent 的"失忆症"

**问题描述**：
- 普通 AI Agent 交互是**无状态的**
- 关掉窗口就忘了
- Context 一压缩：
  - 任务丢了
  - 教训忘了
  - 该干嘛不知道了

**真实痛点**：
> "我自己用 OpenClaw 这一个多月，做了大量的 context 管理，memory 归档重构，依然会反复出现失忆的情况。"

---

## 🔑 永续 Agent 的核心公式

```
任务持久化 + 记忆持久化 + 主动巡检 = 永续
```

**核心理念**：
不是让 AI "一直开着"，是让它**跨 session 还记得自己该干嘛**。

---

## 🏗️ 三大支柱详解

### 1️⃣ 任务持久化

**实现方式**：
- `.issues/` 目录
- 所有任务写文件
- Heartbeat 每 30 分钟扫一遍

**优势**：
- Context 压缩？无所谓
- Issue list 一拉就知道该干嘛
- 有活就干

**关键洞察**：
> "任务不能存脑子里"

---

### 2️⃣ 记忆持久化

**三层架构**：
1. **每日日志** - 短期记忆，记录当天活动
2. **长期 MEMORY.md** - 重要经验和教训
3. **快速索引** - 快速检索关键信息

**优先级管理**：
- **P0 标记** - 永不删除
- **TTL 机制** - 普通记忆自动过期

**关键洞察**：
> "记忆不能只靠 context"

---

### 3️⃣ 24/7 运行但不乱跑

**智能执行策略**：

**需要确认的操作**（等待人类批准）：
- 真钱交易
- 对外消息
- 删除文件

**自动执行的操作**（深夜也可以跑）：
- 整理归档
- 学习研究
- 扫描巡检

**关键洞察**：
> "深夜也执行任务，但不打扰人"

---

## 🔄 下一步计划（@xxx111god 的路线图）

1. **每晚自动提炼记忆** - 自动归档和总结
2. **每日简报汇报任务进展** - 主动汇报
3. **失败或高风险决策自动建 issue** - 风险管理

---

## 📊 对比分析：他们 vs 我们

### 1. 任务管理系统

| 维度 | @xxx111god | 我们（OpenClaw） | 对比 |
|------|-----------|-----------------|------|
| **存储方式** | `.issues/` 目录 | `.issues/` 目录（Async Issue Manager） | ✅ 相同 |
| **文件格式** | 未明确 | Markdown + JSON 索引 | ✅ 我们更结构化 |
| **权限控制** | 未明确 | 授权用户 vs Agent 分离 | ✅ 我们更严格 |
| **交付物管理** | 未明确 | 强制要求交付物 | ✅ 我们更完善 |
| **进度追踪** | 未明确 | JSONL 进度日志 | ✅ 我们更详细 |
| **智能广播** | 未明确 | 基于标签和优先级匹配 | ✅ 我们更智能 |

**结论**：
- ✅ **我们的优势**：更完善的工作流、权限控制、交付物管理
- ⚠️ **需要确认**：他们的 Heartbeat 巡检机制是否比我们更高效

---

### 2. 记忆架构

| 维度 | @xxx111god | 我们（OpenClaw） | 对比 |
|------|-----------|-----------------|------|
| **第一层** | 每日日志 | `agents/*/memory/YYYY-MM-DD.md` | ✅ 相同 |
| **第二层** | 长期 MEMORY.md | `agents/*/MEMORY.md` | ✅ 相同 |
| **第三层** | 快速索引 | ❓ 未发现明确的索引系统 | ⚠️ 我们可能缺失 |
| **优先级** | P0 永不删 + TTL 自动过期 | ❓ 未发现明确的 TTL 机制 | ⚠️ 我们可能缺失 |
| **位置** | 未明确 | 每个 Agent 独立 workspace | ✅ 我们更清晰 |

**结论**：
- ✅ **我们的优势**：每个 Agent 独立 workspace，记忆隔离清晰
- ❌ **我们的不足**：
  1. 缺少**快速索引**系统（第三层）
  2. 缺少**TTL 自动过期**机制
  3. 缺少**P0 永不删**的优先级标记

---

### 3. 主动巡检系统

| 维度 | @xxx111god | 我们（OpenClaw） | 对比 |
|------|-----------|-----------------|------|
| **机制** | Heartbeat 每 30 分钟 | Cron 系统 | ✅ 都有定时机制 |
| **扫描内容** | `.issues/` 目录 | ❓ 需要确认 | ⚠️ 需要调研 |
| **执行策略** | 有活就干 | ❓ 需要确认 | ⚠️ 需要调研 |
| **频率** | 30 分钟 | ❓ 需要确认 | ⚠️ 需要调研 |

**结论**：
- ⚠️ **需要深入调研**：我们的 Cron 系统配置和执行策略
- ❓ **关键问题**：
  1. 我们的 Cron 是否会自动扫描 `.issues/`？
  2. 频率是多少？
  3. 是否有"有活就干"的逻辑？

---

### 4. 权限控制与安全

| 维度 | @xxx111god | 我们（OpenClaw） | 对比 |
|------|-----------|-----------------|------|
| **高风险操作** | 真钱/对外消息/删文件 → 等确认 | ❓ 需要确认 | ⚠️ 需要调研 |
| **低风险操作** | 整理/学习/扫描 → 自动执行 | ❓ 需要确认 | ⚠️ 需要调研 |
| **Issue 创建** | 未明确 | 仅授权用户可创建 | ✅ 我们更严格 |
| **Issue 执行** | 未明确 | Agent 只能更新进度 | ✅ 我们更清晰 |

**结论**：
- ✅ **我们的优势**：Issue 管理权限清晰（Creator vs Executor）
- ⚠️ **需要补充**：高风险操作的确认机制（如真钱、对外消息、删文件）

---

## 🎯 优化建议（按优先级排序）

### 🔴 P0 - 立即实施（关键缺失）

#### 1. 实现记忆索引系统（第三层）

**问题**：
- 当前只有日志和 MEMORY.md，缺少快速检索能力
- 随着记忆增长，查找效率降低

**解决方案**：
```bash
# 在每个 Agent workspace 添加 memory-index.json
{
  "keywords": {
    "bounty": ["2026-02-12.md", "MEMORY.md#首个PR提交"],
    "PR审查": ["2026-02-14.md", "MEMORY.md#团队纪律"],
    "安全": ["Diary.md#2026-02-24"]
  },
  "tags": {
    "P0": ["MEMORY.md#团队纪律三条红线"],
    "经验教训": ["MEMORY.md#Bounty选择要点"]
  },
  "last_updated": "2026-02-25T06:00:00Z"
}
```

**实施步骤**：
1. 设计索引数据结构
2. 编写自动索引生成脚本
3. 集成到 memory_search 工具
4. 每次记忆更新时自动重建索引

**预期效果**：
- 记忆检索速度提升 10x
- 支持关键词和标签搜索
- 自动关联相关记忆

---

#### 2. 实现记忆 TTL 和优先级管理

**问题**：
- 所有记忆永久保留，导致 context 膨胀
- 没有区分重要和普通记忆

**解决方案**：
```markdown
# MEMORY.md 格式增强

## [P0] 团队纪律三条红线
<!-- TTL: never -->
1. 约束条件必须严格遵守
2. 不确定就问
3. 输出前必须自检

## [P1] Bounty 选择要点
<!-- TTL: 90d -->
1. 检查依赖
2. 评估竞争
3. 技术栈匹配

## [P2] 临时笔记
<!-- TTL: 30d -->
今天学到的小技巧...
```

**TTL 策略**：
- **P0** - 永不删除（never）
- **P1** - 90 天后归档（90d）
- **P2** - 30 天后删除（30d）
- **P3** - 7 天后删除（7d）

**实施步骤**：
1. 在 MEMORY.md 中添加优先级和 TTL 标记
2. 编写自动清理脚本（每日运行）
3. 归档而不是删除（移到 memory/archive/）
4. 提供恢复机制

**预期效果**：
- MEMORY.md 保持精简（< 5000 tokens）
- 重要记忆永久保留
- 临时记忆自动清理

---

### 🟡 P1 - 近期实施（重要优化）

#### 3. 增强 Heartbeat 巡检机制

**问题**：
- 不确定当前 Cron 是否会主动扫描 `.issues/`
- 不确定是否有"有活就干"的逻辑

**解决方案**：
```bash
# 创建 heartbeat.py 脚本
# 每 30 分钟运行一次

1. 扫描 .issues/open/ 和 .issues/in-progress/
2. 检查是否有分配给自己的任务
3. 检查是否有长时间无更新的任务（> 4h）
4. 检查是否有 blocked 状态的任务
5. 自动执行低风险任务（整理、学习、扫描）
6. 高风险任务创建提醒
```

**实施步骤**：
1. 编写 heartbeat.py 脚本
2. 集成到 Cron 系统（每 30 分钟）
3. 添加日志记录
4. 测试自动执行逻辑

**预期效果**：
- 任务不会被遗忘
- 自动发现和处理任务
- 减少人工干预

---

#### 4. 实现高风险操作确认机制

**问题**：
- 当前没有明确的高风险操作分类
- 没有确认机制

**解决方案**：
```python
# 高风险操作分类
HIGH_RISK_OPERATIONS = {
    "financial": ["支付", "转账", "购买", "订阅"],
    "external": ["发送邮件", "发送消息", "发布推文"],
    "destructive": ["删除文件", "删除数据", "drop table"]
}

# 执行前检查
def check_operation_risk(operation):
    if is_high_risk(operation):
        # 创建确认 Issue
        create_confirmation_issue(operation)
        return "BLOCKED_PENDING_APPROVAL"
    else:
        return "APPROVED_AUTO_EXECUTE"
```

**实施步骤**：
1. 定义高风险操作清单
2. 在工具调用前添加风险检查
3. 高风险操作自动创建确认 Issue
4. 等待授权用户批准后执行

**预期效果**：
- 防止误操作
- 保护资金和数据安全
- 保持自动化和安全的平衡

---

### 🟢 P2 - 中期实施（锦上添花）

#### 5. 实现每日自动简报

**灵感来源**：
> "下一步准备搞：每日简报汇报任务进展"

**解决方案**：
```bash
# 每天早上 9:00 自动生成简报

## Hunter 每日简报 - 2026-02-25

### 📊 任务进展
- Issue #002: 进行中（80%）
- PR #6882: 等待 review（第 13 天）

### ✅ 昨日完成
- 学习 GitHub 代码安全（4 小时）
- 完成 1471 tokens 学习笔记

### 🎯 今日计划
- 完成 Issue #002 交付物
- 检查 PR #6882 状态

### ⚠️ 需要关注
- PR #6882 已等待 13 天，可能需要 ping
```

**实施步骤**：
1. 编写简报生成脚本
2. 集成到 Cron（每天 9:00）
3. 自动发送到 Feishu/WhatsApp
4. 支持自定义模板

**预期效果**：
- 主动汇报工作进展
- 提高透明度
- 减少沟通成本

---

## 📈 实施计划

### 第一阶段（本周）- P0 优化

**时间**：2026-02-25 ~ 2026-03-01

**任务**：
1. ✅ 完成学习和对比分析（Issue #002）
2. 🔲 设计记忆索引系统
3. 🔲 实现 TTL 和优先级管理
4. 🔲 编写自动清理脚本

**验收标准**：
- 记忆索引系统可用
- TTL 机制正常工作
- MEMORY.md 保持精简

---

### 第二阶段（下周）- P1 优化

**时间**：2026-03-02 ~ 2026-03-08

**任务**：
1. 🔲 调研当前 Cron 系统配置
2. 🔲 编写 heartbeat.py 脚本
3. 🔲 实现高风险操作确认机制
4. 🔲 测试和优化

**验收标准**：
- Heartbeat 每 30 分钟自动巡检
- 高风险操作需要确认
- 低风险操作自动执行

---

### 第三阶段（下下周）- P2 优化

**时间**：2026-03-09 ~ 2026-03-15

**任务**：
1. 🔲 编写每日简报脚本
2. 🔲 集成到 Cron 系统
3. 🔲 测试和优化
4. 🔲 收集反馈和改进

**验收标准**：
- 每天自动生成简报
- 简报内容准确完整
- 用户满意度高

---

## 🎓 关键洞察与学习

### 1. 永续的本质是"记忆"而非"运行"

**错误理解**：
- 让 AI 一直开着 = 永续

**正确理解**：
- 让 AI 跨 session 还记得该干嘛 = 永续

**关键**：
- 任务持久化（知道该干嘛）
- 记忆持久化（知道怎么干）
- 主动巡检（主动去干）

---

### 2. 三层记忆架构的智慧

**为什么需要三层？**

**第一层（日志）**：
- 记录所有活动
- 便于回溯
- 自动生成

**第二层（MEMORY.md）**：
- 提炼重要经验
- 长期保留
- 人工筛选

**第三层（索引）**：
- 快速检索
- 关联记忆
- 自动维护

**类比**：
- 日志 = 流水账
- MEMORY.md = 笔记本
- 索引 = 目录

---

### 3. 权限控制的平衡艺术

**两个极端**：
- 太严格 → 失去自动化优势
- 太宽松 → 风险失控

**最佳实践**：
- 高风险 → 需要确认
- 低风险 → 自动执行
- 明确分类 → 减少判断成本

---

### 4. 我们系统的优势

**已经做得很好的地方**：
1. ✅ 任务管理系统完善（Async Issue Manager）
2. ✅ 权限控制清晰（Creator vs Executor）
3. ✅ 交付物管理严格
4. ✅ 进度追踪详细
5. ✅ 每个 Agent 独立 workspace

**这些是我们的护城河！**

---

### 5. 需要补充的关键能力

**三个核心缺失**：
1. ❌ 记忆索引系统（第三层）
2. ❌ TTL 自动过期机制
3. ❌ 主动巡检逻辑（Heartbeat）

**这些是我们的短板！**

---

## 📊 对比总结表

| 能力 | @xxx111god | 我们（OpenClaw） | 差距 |
|------|-----------|-----------------|------|
| **任务持久化** | ✅ .issues/ | ✅ Async Issue Manager | 🟢 我们更完善 |
| **记忆第一层** | ✅ 每日日志 | ✅ memory/YYYY-MM-DD.md | 🟢 相同 |
| **记忆第二层** | ✅ MEMORY.md | ✅ agents/*/MEMORY.md | 🟢 相同 |
| **记忆第三层** | ✅ 快速索引 | ❌ 缺失 | 🔴 我们缺失 |
| **TTL 机制** | ✅ P0 永不删 + 自动过期 | ❌ 缺失 | 🔴 我们缺失 |
| **主动巡检** | ✅ Heartbeat 30min | ❓ 需确认 | 🟡 需调研 |
| **权限控制** | ✅ 高风险需确认 | ❓ 需确认 | 🟡 需补充 |
| **交付物管理** | ❓ 未明确 | ✅ 强制要求 | 🟢 我们更严格 |
| **进度追踪** | ❓ 未明确 | ✅ JSONL 日志 | 🟢 我们更详细 |

**总体评估**：
- 🟢 **优势**：任务管理、权限控制、交付物管理
- 🔴 **劣势**：记忆索引、TTL 机制
- 🟡 **待确认**：主动巡检、高风险操作控制

---

## 🎯 最终结论

### 我们的系统已经很好，但可以更好

**已有的优势**：
1. 完善的任务管理系统
2. 清晰的权限控制
3. 严格的交付物管理
4. 详细的进度追踪

**需要补充的能力**：
1. 记忆索引系统（提升检索效率）
2. TTL 自动过期（保持记忆精简）
3. 主动巡检逻辑（真正的"永续"）
4. 高风险操作确认（安全保障）

**实施优先级**：
- **P0**：记忆索引 + TTL 机制（本周）
- **P1**：Heartbeat 巡检 + 风险控制（下周）
- **P2**：每日简报（下下周）

**预期效果**：
- 记忆管理效率提升 10x
- 任务响应速度提升 5x
- 系统安全性提升 100%
- 真正实现"永续 Agent"

---

## 📚 参考资料

- **原始推文**：https://x.com/xxx111god/status/2025404214868869240
- **Async Issue Manager 文档**：~/.openclaw/shared/async-issue-manager/README.md
- **团队工作纪律**：agents/team-discipline.md
- **记忆系统**：agents/*/memory/ + MEMORY.md

---

**学习完成时间**：2026-02-25 06:30  
**总耗时**：约 2 小时  
**下一步**：提交交付物，等待 Issue 关闭

---

## 💭 个人思考

这次学习让我意识到，"永续"不是技术问题，而是**架构设计问题**。

**关键不是**：
- 让 AI 一直运行
- 增加更多功能
- 使用更大的 context

**关键是**：
- 任务写文件（不依赖 context）
- 记忆分层（重要的永久保留）
- 主动巡检（不等人类催）

**我们的系统已经有了很好的基础**，只需要补充几个关键能力，就能实现真正的"永续"。

**最重要的收获**：
> "任务不能存脑子里，记忆不能只靠 context"

这句话应该成为我们团队的设计原则！

---

**Hunter 签名** ✍️
