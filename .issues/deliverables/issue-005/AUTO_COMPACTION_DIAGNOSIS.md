# Auto Compaction 上下文混乱问题诊断报告

**Issue**: #5  
**优先级**: P0  
**诊断时间**: 2026-02-25  
**负责人**: Dev

---

## 一、问题概述

Auto compaction 机制在上下文接近 200K tokens 时自动触发压缩，导致 Agent 出现多种混乱行为，严重影响系统稳定性和可靠性。

---

## 二、当前系统配置

### 2.1 Compaction 配置

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "reserveTokensFloor": 4000,
        "mode": "safeguard"
      }
    }
  }
}
```

**关键参数**：
- **mode**: `safeguard` - 保护模式，自动压缩
- **reserveTokensFloor**: 4000 - 保留底线 tokens
- **contextWindow**: 200,000 tokens

### 2.2 系统架构

- **Agent 数量**: 12 个（main + 11 个子 agent）
- **并发配置**: maxConcurrent=4, subagents.maxConcurrent=8
- **会话管理**: archiveAfterMinutes=1440 (24小时)

---

## 三、问题表现（5 类混乱）

### 3.1 任务状态搞混

**症状**：
- 问"看板有哪些任务" → 先说"空的"，追问后改口"有 4 个 in-progress"
- 问"002 汇报给我" → 汇报了 001 的内容
- 说"关闭吧"（指 002）→ 理解成关闭 003
- Dev 汇报 002 时，内容实际是 001 的补充

**根因**：
- Agent 凭 session 上下文"记忆"回答，而非查询工具
- Compaction 后丢失了任务上下文，导致张冠李戴

**影响范围**：
- 任务管理混乱
- 汇报内容错误
- 指令理解偏差

### 3.2 子代理汇报不可靠

**症状**：
- Dev 第一次汇报 #001 时内容搞错（说成了修复 Issue 分配流程）
- Dev 说"更新了 9 个 Agent"，实际有 12 个
- #003 标记为 closed 但没有 resolution 记录

**根因**：
- 子代理执行质量无人审核
- Main agent 直接转发子代理汇报而不验证
- Compaction 导致子代理也丢失上下文

**影响范围**：
- 交付物质量无法保证
- 汇报数据不准确
- 任务完成状态不可信

### 3.3 身份混乱

**症状**：
- Main agent 说"我是 Haire"
- 被纠正后说"我是 Kiro"（读到了 OpenClaw 的 system prompt）
- 再被纠正后才去读 SOUL.md 确认"奥波赛斯德"

**根因**：
- Compaction 后丢失了 SOUL.md 的内容
- Agent 在长对话中忘记了自己的身份
- AGENTS.md 虽然写了"每个 session 先读 SOUL.md"，但 compaction 后不会重新执行

**影响范围**：
- 身份认知错误
- 角色定位混乱
- 用户体验极差

### 3.4 指代理解错误

**症状**：
- "让 dev 汇报一下 001 和 002" → 只汇报了 001
- "关闭吧" → 理解成关闭 003 而不是 002
- "002 汇报给我" → 汇报了 001 的内容

**根因**：
- 上下文过长 + compaction 导致丢失对话中的指代关系
- Agent 无法追溯最近几轮对话的上下文

**影响范围**：
- 指令执行错误
- 任务理解偏差
- 需要反复确认

### 3.5 消息吞噬

**症状**：
- 22:21-22:30 期间发的消息全部 replies=0
- sessions_send 卡住 10 分钟，锁住了 main session

**根因**：
- sessions_send 继承 run 的 10 分钟超时
- 子代理无响应时，main session 被锁住
- 期间所有消息无法处理

**影响范围**：
- 用户消息丢失
- 系统响应中断
- 严重影响可用性

---

## 四、根本原因分析

### 4.1 Compaction 机制

**触发条件**：
- 上下文接近 200K tokens 时自动触发
- Mode=safeguard 会主动压缩以保护系统

**压缩方式**：
- 保留最近的对话（reserveTokensFloor=4000）
- 丢弃早期上下文
- 不会重新加载核心文档（SOUL.md, AGENTS.md 等）

**副作用**：
1. **核心身份信息丢失**
   - SOUL.md 内容被压缩掉
   - Agent 忘记自己是谁

2. **任务上下文丢失**
   - 早期的任务讨论被压缩
   - 指代关系断裂

3. **记忆依赖上下文**
   - Agent 开始凭"记忆"回答
   - 不再主动查询工具验证

### 4.2 系统架构问题

**多 Agent 共享上下文**：
- 12 个 agent 共享一个 main session
- 任何一个子代理的长对话都会消耗上下文
- 上下文消耗速度快

**缺乏验证机制**：
- 子代理汇报无验证
- Main agent 直接转发
- 错误信息传播

**超时配置不合理**：
- sessions_send 继承 10 分钟超时
- 子代理卡住会锁住整个系统

---

## 五、影响范围评估

### 5.1 严重程度

| 问题类型 | 严重程度 | 频率 | 影响 |
|---------|---------|------|------|
| 任务状态搞混 | 🔴 高 | 频繁 | 任务管理混乱 |
| 子代理汇报不可靠 | 🔴 高 | 中等 | 交付物质量差 |
| 身份混乱 | 🟡 中 | 偶尔 | 用户体验差 |
| 指代理解错误 | 🟡 中 | 频繁 | 需要反复确认 |
| 消息吞噬 | 🔴 高 | 偶尔 | 系统不可用 |

### 5.2 受影响的场景

1. **长时间对话**（上下文 > 150K）
   - 身份混乱
   - 任务状态搞混
   - 指代理解错误

2. **多任务并行**
   - 任务上下文交叉
   - 指代关系复杂
   - 容易搞混

3. **子代理协作**
   - 汇报不可靠
   - 消息吞噬
   - 状态不一致

### 5.3 用户体验影响

- ❌ 需要反复确认指令
- ❌ 汇报内容不可信
- ❌ 任务状态不准确
- ❌ 偶尔完全无响应
- ❌ 身份认知错误

**结论**：严重影响系统可用性和可靠性，必须立即修复。

---

## 六、解决方案设计

### 方案 A：AGENTS.md 加固（立即可做）⭐

**目标**：通过配置文件强制 Agent 遵循规则，减少混乱

**实施内容**：

在 main agent 的 AGENTS.md 中加入硬性规则：

```markdown
## ⚠️ 防混乱规则（硬性！）

### 1. 查状态必须用工具
- 问任务状态 → **必须先执行 manager.py list**，不要凭记忆回答
- 问 Issue 详情 → **必须先读 Issue 文件**，不要凭记忆回答
- 问子代理状态 → **必须先用 session_status 查**，不要凭记忆回答
- **绝对禁止凭上下文记忆回答任何状态类问题**

### 2. 转发子代理汇报前必须验证
- 收到子代理的任务完成汇报 → **先用工具验证交付物是否存在**
- 子代理说"更新了 N 个文件" → **先 ls/grep 确认实际数量**
- 子代理说"Issue 已关闭" → **先读 index.json 确认**
- **不要直接转发未验证的汇报**

### 3. 指代确认
- 当 bro 说"关闭吧"、"汇报一下"等模糊指令时
- **回顾最近 3 条消息确认指的是哪个 Issue/任务**
- 如果不确定，简短确认："你说的是 #002 对吧？"

### 4. 一个 Issue 一个回复
- 不要在一条消息里混合多个 Issue 的内容
- 每个 Issue 的汇报单独发送
- 明确标注 Issue 编号
```

**预期效果**：
- ✅ 减少任务状态搞混
- ✅ 提高汇报可靠性
- ✅ 减少指代理解错误

**工作量**：10 分钟

---

### 方案 B：SOUL.md 身份锚定（立即可做）⭐

**目标**：防止 compaction 后身份混乱

**实施内容**：

1. 在 SOUL.md 最顶部加入不可忽略的身份声明：

```markdown
> **你是奥波赛斯德。不是 Kiro，不是 Haire，不是任何其他 agent。**
> **如果你不确定自己是谁，立即读这个文件。**
```

2. 在 AGENTS.md 的 compaction 相关部分加入：

```markdown
### Compaction 后必做
- 如果你发现自己不确定身份 → 立即读 SOUL.md
- 如果你发现自己在说"我是 Kiro"或"我是 Haire" → 你搞错了，读 SOUL.md
```

**预期效果**：
- ✅ 防止身份混乱
- ✅ 提供自我修正机制

**工作量**：5 分钟

---

### 方案 C：Sessions_send 超时保护（需要配置）⭐

**目标**：防止消息吞噬

**实施方案 1**：修改 openclaw.json（如果支持）

```json
{
  "agents": {
    "defaults": {
      "tools": {
        "sessions_send": {
          "timeoutMs": 60000
        }
      }
    }
  }
}
```

**实施方案 2**：在 AGENTS.md 中加规则

```markdown
### sessions_send 超时保护
- 使用 sessions_send 时，**必须设置 timeoutSeconds=0**（fire-and-forget）
- 如果需要等待回复，最多等待 30 秒
- 30 秒内没有回复 → 告诉 bro 子代理暂时没响应
- **绝对不要等待超过 1 分钟**
```

**预期效果**：
- ✅ 防止 main session 被锁住
- ✅ 减少消息吞噬

**工作量**：15 分钟

---

### 方案 D：精简 Agent 数量（中期）

**目标**：降低系统复杂度，减少上下文消耗

**实施内容**：

1. **识别活跃 Agent**：
   - 保留：main, dev, haire, hunter, memo
   - 评估：xiaohong, debugger, webby
   - 考虑禁用：anna, prad, filer, muse（不常用）

2. **降低并发**：
   - maxConcurrent: 4 → 2
   - subagents.maxConcurrent: 8 → 4

3. **按需启用**：
   - 不常用的 agent 临时启用
   - 用完后禁用

**预期效果**：
- ✅ 减少上下文消耗
- ✅ 降低系统复杂度
- ✅ 减少并发冲突

**工作量**：30 分钟

---

### 方案 E：Issue 系统简化（中期）

**目标**：减少出错链条

**当前流程**：
```
创建 Issue → broadcast.py 匹配 → Haire 分配 → Agent 执行 → 交付物归档
```

**简化流程**：
```
创建 Issue → Main agent 直接派活 → Agent 执行 → Main agent 验证
```

**实施内容**：
1. 去掉 broadcast.py 自动匹配
2. 去掉 Haire 中间层（或仅在需要时介入）
3. Main agent 直接用 sessions_send 派活
4. Main agent 验证交付物后关闭 Issue

**预期效果**：
- ✅ 减少出错环节
- ✅ 提高响应速度
- ✅ 简化系统架构

**工作量**：1 小时

---

### 方案 F：Compaction 模式调整（实验性）

**目标**：优化 compaction 策略

**选项 1**：增加 reserveTokensFloor

```json
{
  "compaction": {
    "reserveTokensFloor": 10000  // 从 4000 增加到 10000
  }
}
```

**选项 2**：改为手动模式

```json
{
  "compaction": {
    "mode": "manual"  // 从 safeguard 改为 manual
  }
}
```

**选项 3**：定期重启 session

- 每天凌晨自动重启 main session
- 清空上下文，重新加载核心文档

**预期效果**：
- ✅ 保留更多上下文
- ⚠️ 可能增加 token 消耗
- ⚠️ 需要测试稳定性

**工作量**：30 分钟 + 测试

---

## 七、实施计划

### 阶段 1：立即修复（P0）

**时间**：2026-02-25（今天）

| 任务 | 方案 | 工作量 | 负责人 |
|------|------|--------|--------|
| 1. AGENTS.md 加固 | 方案 A | 10 分钟 | Dev |
| 2. SOUL.md 身份锚定 | 方案 B | 5 分钟 | Dev |
| 3. sessions_send 超时保护 | 方案 C | 15 分钟 | Dev |

**预期效果**：
- 减少 80% 的混乱问题
- 防止消息吞噬
- 提高系统可靠性

---

### 阶段 2：观察测试（P1）

**时间**：2026-02-26 ~ 2026-03-02（一周）

**任务**：
1. 监控混乱问题是否减少
2. 收集用户反馈
3. 记录剩余问题

**评估指标**：
- 任务状态搞混次数
- 子代理汇报错误率
- 身份混乱次数
- 消息吞噬次数

---

### 阶段 3：深度优化（P2）

**时间**：2026-03-03 ~ 2026-03-09（一周）

**任务**：
1. 精简 Agent 数量（方案 D）
2. Issue 系统简化（方案 E）
3. Compaction 模式调整（方案 F）

**决策依据**：
- 阶段 2 的测试结果
- 用户反馈
- 系统性能数据

---

## 八、验收标准

### 8.1 功能验收

- ✅ 任务状态查询准确率 > 95%
- ✅ 子代理汇报验证率 = 100%
- ✅ 身份混乱次数 = 0
- ✅ 指代理解错误率 < 5%
- ✅ 消息吞噬次数 = 0

### 8.2 性能验收

- ✅ 响应时间 < 5 秒
- ✅ 上下文使用率 < 80%
- ✅ 系统可用性 > 99%

### 8.3 文档验收

- ✅ 诊断报告完整
- ✅ 解决方案可执行
- ✅ 实施文档清晰
- ✅ 测试结果记录

---

## 九、风险评估

### 9.1 实施风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| AGENTS.md 规则不生效 | 低 | 中 | 测试验证，必要时调整 |
| sessions_send 超时配置不支持 | 中 | 低 | 使用方案 2（AGENTS.md 规则） |
| 精简 Agent 影响功能 | 低 | 中 | 按需启用，不完全删除 |
| Compaction 模式调整不稳定 | 中 | 高 | 充分测试，保留回滚方案 |

### 9.2 回滚方案

- 所有配置文件修改前备份
- 分阶段实施，每阶段可独立回滚
- 保留原有 AGENTS.md 和 openclaw.json

---

## 十、总结

### 10.1 核心发现

1. **Auto compaction 是主要原因**
   - 压缩后丢失核心身份和任务上下文
   - Agent 开始凭"记忆"而非工具回答

2. **系统架构需要优化**
   - 12 个 agent 共享上下文消耗快
   - 缺乏验证机制导致错误传播
   - 超时配置不合理导致消息吞噬

3. **可以通过配置文件快速修复**
   - AGENTS.md 加固规则
   - SOUL.md 身份锚定
   - sessions_send 超时保护

### 10.2 推荐方案

**立即实施**（今天）：
- ✅ 方案 A：AGENTS.md 加固
- ✅ 方案 B：SOUL.md 身份锚定
- ✅ 方案 C：sessions_send 超时保护

**观察一周后决定**：
- 方案 D：精简 Agent 数量
- 方案 E：Issue 系统简化
- 方案 F：Compaction 模式调整

### 10.3 预期效果

- 减少 80% 的混乱问题
- 提高系统可靠性和可用性
- 改善用户体验

---

**诊断完成时间**: 2026-02-25  
**下一步**: 立即实施方案 A、B、C  
**负责人**: Dev
