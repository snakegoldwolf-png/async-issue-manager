<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoryonClaw Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .gradient-text { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .glow { box-shadow: 0 0 30px rgba(96, 165, 250, 0.3); }
    </style>
</head>
<body class="text-white p-4 md:p-8">
    <!-- Header -->
    <header class="max-w-6xl mx-auto mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold gradient-text">LoryonClaw Dashboard</h1>
                <p class="text-slate-400 mt-1">ÂÆûÊó∂ Token & API ‰ΩøÁî®ÁªüËÆ°</p>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-slate-500" id="last-update">Êõ¥Êñ∞‰∏≠...</span>
                <button onclick="loadData()" class="glass px-4 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Âà∑Êñ∞
                </button>
                <a href="/issues" class="glass px-4 py-2 rounded-lg hover:bg-white/10 transition">üìã Issues</a>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <!-- Like¬∑AI API Stats -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-slate-300 mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full pulse"></span>
                Like¬∑AI API
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass stat-card rounded-2xl p-6 glow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm mb-1">API ËØ∑Ê±ÇÊï∞</p>
                            <p class="text-4xl font-bold text-blue-400" id="api-requests">-</p>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center">
                            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="glass stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm mb-1">API Token Êï∞</p>
                            <p class="text-4xl font-bold text-purple-400" id="api-tokens">-</p>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-purple-500/20 flex items-center justify-center">
                            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Local Agent Stats -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-slate-300 mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full pulse"></span>
                Êú¨Âú∞ Agent ÁªüËÆ°
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass stat-card rounded-2xl p-5">
                    <p class="text-slate-400 text-sm mb-1">ÊÄª Token</p>
                    <p class="text-2xl font-bold text-emerald-400" id="local-tokens">-</p>
                </div>
                <div class="glass stat-card rounded-2xl p-5">
                    <p class="text-slate-400 text-sm mb-1">ÊÄªËØ∑Ê±Ç</p>
                    <p class="text-2xl font-bold text-cyan-400" id="local-requests">-</p>
                </div>
                <div class="glass stat-card rounded-2xl p-5">
                    <p class="text-slate-400 text-sm mb-1">Agent Êï∞</p>
                    <p class="text-2xl font-bold text-amber-400" id="agent-count">-</p>
                </div>
                <div class="glass stat-card rounded-2xl p-5">
                    <p class="text-slate-400 text-sm mb-1">Session Êï∞</p>
                    <p class="text-2xl font-bold text-rose-400" id="session-count">-</p>
                </div>
            </div>
        </section>

        <!-- Agent Usage Chart -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-slate-300 mb-4">Agent Token ‰ΩøÁî®ÂàÜÂ∏É</h2>
            <div class="glass rounded-2xl p-6">
                <canvas id="agentChart" height="300"></canvas>
            </div>
        </section>

        <!-- Top Agents Table -->
        <section>
            <h2 class="text-xl font-semibold text-slate-300 mb-4">Top Agents</h2>
            <div class="glass rounded-2xl overflow-hidden">
                <table class="w-full">
                    <thead class="bg-white/5">
                        <tr class="text-slate-400 text-sm">
                            <th class="text-left py-3 px-4">#</th>
                            <th class="text-left py-3 px-4">Agent</th>
                            <th class="text-left py-3 px-4">Tokens</th>
                            <th class="text-left py-3 px-4 hidden md:table-cell">Requests</th>
                            <th class="text-left py-3 px-4">Âç†ÊØî</th>
                        </tr>
                    </thead>
                    <tbody id="agent-table">
                        <tr><td colspan="5" class="py-8 text-center text-slate-500">Âä†ËΩΩ‰∏≠...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="max-w-6xl mx-auto mt-12 text-center text-slate-500 text-sm">
        <p>LoryonClaw Dashboard ¬∑ Êï∞ÊçÆÊØè 30 ÁßíËá™Âä®Âà∑Êñ∞</p>
    </footer>

    <script>
        let agentChart = null;
        const API_URL = '/issues/api/usage';

        function formatNumber(num) {
            if (typeof num === 'string') return num;
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + '?t=' + Date.now());
                const data = await res.json();

                // Like¬∑AI Stats
                if (data.likeai && data.likeai.data) {
                    const ld = data.likeai.data;
                    document.getElementById('api-requests').textContent = formatNumber(ld.total_requests || 0);
                    document.getElementById('api-tokens').textContent = ld.total_tokens || '-';
                }

                // Local Stats
                const s = data.summary || {};
                document.getElementById('local-tokens').textContent = formatNumber(s.total_tokens || 0);
                document.getElementById('local-requests').textContent = formatNumber(s.total_requests || 0);
                document.getElementById('agent-count').textContent = s.agent_count || 0;
                document.getElementById('session-count').textContent = formatNumber(s.session_count || 0);

                // Agent Table
                const agents = (data.by_agent || []).slice(0, 10);
                const totalTokens = s.total_tokens || 1;
                const colors = ['#60a5fa', '#a78bfa', '#f472b6', '#34d399', '#fbbf24', '#fb7185', '#38bdf8', '#c084fc', '#4ade80', '#f97316'];

                const tableHtml = agents.map((a, i) => {
                    const pct = ((a.total_tokens / totalTokens) * 100).toFixed(1);
                    return `
                        <tr class="border-t border-white/5 hover:bg-white/5 transition">
                            <td class="py-3 px-4 text-slate-500">${i + 1}</td>
                            <td class="py-3 px-4 font-medium" style="color: ${colors[i]}">${a.name}</td>
                            <td class="py-3 px-4">${formatNumber(a.total_tokens)}</td>
                            <td class="py-3 px-4 hidden md:table-cell text-slate-400">${formatNumber(a.requests)}</td>
                            <td class="py-3 px-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-20 h-2 bg-white/10 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width: ${pct}%; background: ${colors[i]}"></div>
                                    </div>
                                    <span class="text-sm text-slate-400">${pct}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('agent-table').innerHTML = tableHtml || '<tr><td colspan="5" class="py-8 text-center text-slate-500">Êó†Êï∞ÊçÆ</td></tr>';

                // Chart
                const chartData = agents.slice(0, 6);
                if (agentChart) agentChart.destroy();
                const ctx = document.getElementById('agentChart').getContext('2d');
                agentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.map(a => a.name),
                        datasets: [{
                            data: chartData.map(a => a.total_tokens),
                            backgroundColor: colors.slice(0, chartData.length),
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#94a3b8', font: { size: 13 }, padding: 15 }
                            }
                        },
                        cutout: '60%'
                    }
                });

                // Update time
                document.getElementById('last-update').textContent = 'Êõ¥Êñ∞‰∫é ' + new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
