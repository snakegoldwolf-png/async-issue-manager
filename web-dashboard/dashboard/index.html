<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoryonClaw Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg: #1a2e1a;
            --bg-accent: #243524;
            --bg-elevated: #2e422e;
            --card: #3a5a3a;
            --text: #e8f5e8;
            --text-strong: #f0fff0;
            --muted: #90b090;
            --border: #4a6a4a;
            --border-strong: #5a8a5a;
            --accent: #ff9ecd;
            --accent-hover: #ffb8db;
            --ok: #7cb342;
            --warn: #ffb300;
            --danger: #e53935;
        }

        * { font-family: 'VT323', 'Courier New', monospace !important; }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .pixel-border {
            border: 3px solid var(--border);
            box-shadow: 
                inset -2px -2px 0 var(--bg),
                inset 2px 2px 0 var(--border-strong);
        }

        .stat-card {
            background: var(--card);
            border: 3px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .progress-bar {
            background: var(--bg-accent);
            border: 2px solid var(--border);
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--ok) 0%, var(--accent) 100%);
            transition: width 0.5s ease;
        }

        .agent-row:hover {
            background: var(--bg-elevated);
        }

        .nav-link {
            color: var(--muted);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: var(--accent);
            background: var(--bg-accent);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        .big-number {
            font-size: 3rem;
            line-height: 1;
        }

        @media (max-width: 640px) {
            .big-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Header -->
    <header class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl text-[var(--accent)] flex items-center gap-3">
                    ğŸ“Š LoryonClaw Dashboard
                </h1>
                <p class="text-[var(--muted)] mt-1">Token & API ä½¿ç”¨ç»Ÿè®¡</p>
            </div>
            <nav class="flex gap-2">
                <a href="/issues" class="nav-link">ğŸ“‹ Issues</a>
                <button onclick="loadData()" class="nav-link cursor-pointer">ğŸ”„ åˆ·æ–°</button>
            </nav>
        </div>
    </header>

    <!-- LikeÂ·AI Stats (Primary) -->
    <div class="pixel-border rounded-lg p-6 mb-8" style="background: var(--bg-accent);">
        <h2 class="text-2xl text-[var(--accent)] mb-6 flex items-center gap-2">
            â˜ï¸ LikeÂ·AI API ç»Ÿè®¡
            <span class="text-sm text-[var(--muted)]" id="likeai-updated"></span>
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-sm text-[var(--muted)] mb-2">API è¯·æ±‚æ•°</div>
                <div class="big-number text-[var(--accent)]" id="likeai-requests">-</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-sm text-[var(--muted)] mb-2">Token ä½¿ç”¨é‡</div>
                <div class="big-number text-[var(--ok)]" id="likeai-tokens">-</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-sm text-[var(--muted)] mb-2">å¥—é¤ç±»å‹</div>
                <div class="text-2xl text-[var(--text)]" id="likeai-plan">-</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-sm text-[var(--muted)] mb-2">å‰©ä½™æ—¶é—´</div>
                <div class="big-number text-[var(--warn)]" id="likeai-balance">-</div>
            </div>
        </div>
    </div>

    <!-- Local Agent Stats -->
    <div class="pixel-border rounded-lg p-6 mb-8" style="background: var(--bg-accent);">
        <h2 class="text-2xl text-[var(--accent)] mb-6">ğŸ¤– æœ¬åœ° Agent ç»Ÿè®¡</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-sm text-[var(--muted)] mb-1">æ€» Token æ•°</div>
                <div class="text-2xl text-[var(--accent)]" id="total-tokens">-</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-sm text-[var(--muted)] mb-1">æ€»è¯·æ±‚æ•°</div>
                <div class="text-2xl text-[var(--ok)]" id="total-requests">-</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-sm text-[var(--muted)] mb-1">Agent æ•°</div>
                <div class="text-2xl text-[var(--warn)]" id="agent-count">-</div>
            </div>
            <div class="stat-card rounded-lg p-4 text-center">
                <div class="text-sm text-[var(--muted)] mb-1">Session æ•°</div>
                <div class="text-2xl text-[var(--text)]" id="session-count">-</div>
            </div>
        </div>

        <!-- Agent Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-[var(--muted)] text-left border-b border-[var(--border)]">
                        <th class="py-2 px-2">#</th>
                        <th class="py-2 px-2">Agent</th>
                        <th class="py-2 px-2">Total Tokens</th>
                        <th class="py-2 px-2 hidden md:table-cell">Requests</th>
                        <th class="py-2 px-2 w-32">å æ¯”</th>
                    </tr>
                </thead>
                <tbody id="agent-table">
                    <tr><td colspan="5" class="py-4 text-center text-[var(--muted)] loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-[var(--muted)] text-sm mt-8">
        <p>LoryonClaw Dashboard Â· æ•°æ®æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°</p>
    </footer>

    <script>
        // ä» API åŠ è½½æ•°æ®
        const API_URL = '/issues/api/usage';

        function formatNumber(num) {
            if (typeof num === 'string') return num;
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatNumberFull(num) {
            if (typeof num === 'string') return num;
            return num.toLocaleString();
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + '?t=' + Date.now());
                const data = await res.json();
                
                // LikeÂ·AI Stats
                if (data.likeai && data.likeai.data) {
                    const ld = data.likeai.data;
                    document.getElementById('likeai-requests').textContent = formatNumber(ld.total_requests || 0);
                    document.getElementById('likeai-tokens').textContent = ld.total_tokens || '-';
                    document.getElementById('likeai-plan').textContent = ld.keys && ld.keys[0] ? ld.keys[0].group : '-';
                    document.getElementById('likeai-balance').textContent = ld.keys && ld.keys[0] ? ld.keys[0].balance : '-';
                    
                    if (data.likeai.fetched_at) {
                        const fetchedDate = new Date(data.likeai.fetched_at);
                        document.getElementById('likeai-updated').textContent = 
                            'æ›´æ–°äº ' + fetchedDate.toLocaleString('zh-CN', { 
                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                            });
                    }
                }

                // Local Stats
                const summary = data.summary || {};
                document.getElementById('total-tokens').textContent = formatNumber(summary.total_tokens || 0);
                document.getElementById('total-tokens').title = formatNumberFull(summary.total_tokens || 0);
                document.getElementById('total-requests').textContent = formatNumber(summary.total_requests || 0);
                document.getElementById('agent-count').textContent = summary.agent_count || 0;
                document.getElementById('session-count').textContent = formatNumber(summary.session_count || 0);

                // Agent Table
                const agents = data.by_agent || [];
                const maxTokens = agents.length > 0 ? agents[0].total_tokens : 1;
                const totalTokens = summary.total_tokens || 1;
                
                const agentHtml = agents.slice(0, 15).map((agent, idx) => {
                    const percent = ((agent.total_tokens / totalTokens) * 100).toFixed(1);
                    const barWidth = (agent.total_tokens / maxTokens) * 100;
                    return `
                        <tr class="agent-row border-b border-[var(--border)]">
                            <td class="py-2 px-2 text-[var(--muted)]">${idx + 1}</td>
                            <td class="py-2 px-2 font-bold text-[var(--accent)]">${agent.name}</td>
                            <td class="py-2 px-2" title="${formatNumberFull(agent.total_tokens)}">${formatNumber(agent.total_tokens)}</td>
                            <td class="py-2 px-2 hidden md:table-cell">${formatNumber(agent.requests)}</td>
                            <td class="py-2 px-2">
                                <div class="progress-bar rounded h-4 relative">
                                    <div class="progress-fill h-full rounded" style="width: ${barWidth}%"></div>
                                    <span class="absolute inset-0 flex items-center justify-center text-xs">${percent}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('agent-table').innerHTML = agentHtml || '<tr><td colspan="5" class="py-4 text-center text-[var(--muted)]">æ— æ•°æ®</td></tr>';

            } catch (err) {
                console.error('Failed to load data:', err);
                document.getElementById('agent-table').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-[var(--danger)]">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
            }
        }

        // Load on page load
        loadData();
        
        // Auto refresh every 60 seconds
        setInterval(loadData, 60000);
    </script>
</body>
</html>
